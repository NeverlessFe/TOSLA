
@{
    ViewBag.Title = "Report_SPB_Preview";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href=" https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<script src="https://kit.fontawesome.com/0507c93dbe.js" crossorigin="anonymous"></script>

<style>
    .dataTables_filter {
        position: relative;
    }

        .dataTables_filter input {
            width: 250px;
            height: 32px;
            background: #fcfcfc;
            border: 1px solid #aaa;
            border-radius: 5px;
            box-shadow: 0 0 3px #ccc, 0 10px 15px #ebebeb inset;
            text-indent: 10px;
        }

        .dataTables_filter .fa-search {
            position: absolute;
            top: 10px;
            left: auto;
            right: 10px;
        }

    @@media (min-width: 768px) {
        .modal-xl {
            width: 900%;
            max-width: 1300px;
        }
    }

    .select2-selection__rendered {
        line-height: 40px !important;
    }

    .select2-container .select2-selection--single {
        height: 40px !important;
    }

    .select2-selection__arrow {
        height: 40px !important;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10" style="margin: 0 auto;
                                     float: none;
                                     margin-bottom: 10px; ">
            <div class="card">
              
                <div class="card-body">
                    <div id="divNormal">
                        <div class="col-md-12">
                            <h2>Report SPB Preview</h2>
                        </div>
                        <hr class="solid">
                    </div>
                    <div id="divReject" hidden>
                        <div class="col-md-12" >
                            <h2>
                                <img src="~/Content/images/rejected.png" width="190" height="70" style="float: right">
                                Report SPB Preview (Rejected)
                            </h2>   

                        </div>
                        <div class="col-md-12" >
                            <label style="font-weight: bold; margin-right: 10px; font-size: 20px"> Alasan Reject: </label><label style=" margin-right: 10px; font-size: 20px" id="txtAlasanReject"></label>
                        </div>
                        <hr class="solid">
                    </div>

                    <div style="border-style: groove">
                        <div style="margin: 90px">
                            <div class="col-md-12">
                                <div style="float: right" id="divDate">
                                    <label id="labelDate">Date</label>
                                </div>
                                <div style="height: 30px">
                                    <label style="line-height: 40px; margin-right: 2px">No </label>
                                    <label style="margin-left: 50px; line-height: 40px;">: <label style="font-weight: bold;">@Request.QueryString.Get("No_Surat")</label></label>
                                </div>
                                <div style="height: 30px">
                                    <label style="line-height: 40px;">Hal </label>
                                    <label style="margin-left: 50px; line-height: 40px;">: Pemberitahuan Pembayaran Income </label>
                                </div>
                            </div>
                            <br />
                            <div class="col-md-12">
                                <div style="">
                                    <b style="">Kepada Yth, </b><br />
                                    <b id="txtGender">-</b> <b id="txtName">-</b><br />
                                    <b style="" id="txtCompany">-</b><br />
                                    <b style="" id="txtCity">-</b><br />

                                </div>
                            </div>
                            <br />
                            <div class="col-md-12">
                                <div style="">
                                    Dengan hormat,<br />
                                    Bersama ini kami kirimkan lampiran income periode <a id="txtPeriode">-</a> <br />
                                    dengan total keseluruhan pembayaran : <br />

                                </div>
                                <div class="row form-group" id="divTable">
                                    <div class="col-md-12">
                                        <br />
                                        <div id="form_tableSPB" class="form-group row">
                                            <table id="tbl_Payment" class="cell-border" style="width: 50%; float: left">
                                                <thead style="">
                                                    <tr>
                                                        <th>TEAM</th>
                                                        <th>PERIODE</th>
                                                        <th>TOTAL INCOME</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tBodyPayment">
                                                </tbody>
                                                <tfoot class="cell-border">
                                                    <tr>
                                                        <th>Total</th>
                                                        <th></th>
                                                        <th id="txtTotal">$180</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div style="">
                                    <a> Mohon biaya tersebut ditalangi terlebih dahulu dan akan di bayarkan lewat saldo DF </a> <label id="txtYear" style="height: 10px"> 2000 </label> <br />
                                    <a> yang akan di terbitkan dengan Payment Approval (PA)</a> <br />
                                    <br />
                                    <a> Demikian pemberitahuan ini kami sampaikan, Atas perhatian dan kerjasamanya kami </a><br />
                                    <a> ucapkan terima kasih.</a><br />
                                </div>
                            </div>
                            <br />
                            <div class="col-md-12">
                                <br />
                                <div style="">
                                    <a> Hormat Kami, </a> <br />
                                </div>
                            </div>
                            <br />
                            <div class="col-md-12">
                                <br />
                                <br />
                                <div style="">
                                    <div id="left" style="float: left; margin-right: -50px; text-align: center">
                                        <b>
                                            <p><u id="txtApprover1">This text will be underlined.</u></p>
                                        </b>
                                        <b id="txtJabatan1">Jabatan</b> <br />
                                    </div>
                                    <div id="right" style="float: right; margin-left: 50px; text-align: center">
                                        <b>
                                            <p><u id="txtApprover3">This text will be underlined.</u></p>
                                        </b>
                                        <b id="txtJabatan3">Jabatan</b> <br />
                                    </div>
                                    <div id="center" style="margin: 0 auto; width: 300px; text-align: left; text-align: center">
                                        <b>
                                            <p><u id="txtApprover2">This text will be underlined.</u></p>
                                        </b>
                                        <b id="txtJabatan2">Jabatan</b> <br />
                                    </div>
                                </div>

                            </div>
                            @*<br /> <br /> <br />
                <div class="col-md-12">
                    <div style="">
                        <div id="left" style="float: left; margin-right: -50px">
                            <b>Head Office</b> <br />
                            <text>Jl. Jend. A. Yani No.2,</text><br />
                            <text>Pulomas Jakarta 13210 Indonesia</text><br />
                            <text>P: 62-21-475-7777</text><br />
                        </div>
                        <div id="right" style="float: right; margin-left: 50px">
                            <b>Factory 2</b> <br />
                            <text>Kawasan Greenland International Industrial Center (GIIC)</text><br />
                            <text>Blok BB No.7, Desa Sukamahi, Kecamatan Cikarang Pusat,</text><br />
                            <text>Kabupaten Bekasi, Jawa Barat 17530 Indonesia</text><br />
                            <text>P: 62-21-5085-0277</text><br />
                        </div>
                        <div id="center" style="margin: 0 auto; width: 300px; text-align: left;">
                            <b>Factory 1</b> <br />
                            <text>Jl. Rawa Sumur Barat II K-9,</text><br />
                            <text>Kawasan Industri Pulogadung</text><br />
                            <text>Jakarta 13930 Indonesia</text><br />
                            <text>P: 62-21-460-5533</text><br />
                        </div>
                    </div>
                </div>*@
                        </div>
                    </div>

                </div>
            </div>
            <div class="card" id="divAction" >
                <div class="card-body">
                    @*  <h2>Action</h2>
                    <hr class="solid">*@
                    <div style="text-align: center;">
                        <button class="btn btn-primary approve" style="background-color: #28de7a; border-color: #28de7a; margin-left: 10px;  width: 200px" id="btn_Approve">Approve <i class="fa-regular fa-circle-check"></i></button> 
                        <button class="btn btn-primary reject" style="background-color: red; border-color: red; margin-left: 10px; margin: 0 auto; width: 200px" id="btn_Reject" value="Reject">Reject <i class="fa-solid fa-ban"></i></button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var No_Surat = "@Request.QueryString.Get("No_Surat")";
    var status = "@Request.QueryString.Get("Status")";
    var lineNumber = "@Request.QueryString.Get("LineNumber")";
    var uploader = "@Request.RequestContext.HttpContext.Session["UserName"]";
    var alasanReject = '';

    @*console.log(No_Surat);
    console.log(lineNumber);*@

    $(document).ready(function () {
        $('#tbl_Payment').dataTable();
        getData();
        getTableData();
        //Date Format -> dd MM yyyy
        var date = new Date();
        var options = { weekday: undefined, year: 'numeric', month: 'long', day: 'numeric' };
        $('#labelDate').text('Jakarta, ' + date.toLocaleDateString("en-GB", options));

        var year = new Date().getFullYear();
        $('#txtYear').text(year);

        $('#btn_Approve').click(function () {
            Swal.fire({
                title: "Warning!",
                text: "Approve Report?",
                type: "warning",
                showConfirmButton: true
            }).then((result) => {
                if (result.value) {
                    approveReport();
                }
            });
        });

        $('#btn_Reject').click(function () {
            Swal.fire({
                type: 'warning',
                title: 'Mohon Masukkan Alasan Reject!',
                input: 'textarea',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Submit',
                showLoaderOnConfirm: true,

                allowOutsideClick: () => Swal.isLoading()
            }).then((result) => {

                if (result.value == null || result.value == '') {
                    Swal.fire({
                        type: 'error',
                        title: 'Oops...',
                        text: 'Alasan Reject Tidak Boleh Kosong!'
                    });
                } else {
                    alasanReject = result.value;
                    rejectReport();
                }
            });
        });

        if (status === 'REJECTED') {
            $('#divAction').attr('hidden', true);
            $('#divNormal').attr('hidden', true);
            $('#divReject').attr('hidden', false);

            getAlasanReject();
        }
        if (status === 'APPROVED') {
            $('#divAction').attr('hidden', true);
        }
    });

    function getTableData() {
        var dictlist = {
            Option: "Get Table Payment",
            NoSPB: No_Surat
        }
        var dto = {
            Model: dictlist
        }
        $.ajax({
            url: "../UploadMemo/DynamicController?spname=SP_Signature",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var result = JSON.parse(data);
                var table = $('#tbl_Payment').DataTable({
                    "pageLength": 5,
                    "data": JSON.parse(data),
                    "filter": false,
                    "lengthChange": false,
                    "paging": false,
                    "info": false,
                    "searching": false,
                    "select": false,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        { "data": "Team" },
                        { "data": "Periode" },
                        { "data": "TotalIncome" },
                    ],

                    "order": [[0, 'asc']],
                    "columnDefs": [
                        { "width": "30%", "targets": [0, 1, 2] },
                        { className: 'cell-border', "targets": "_all"},
                    ]
                });
                $('#txtTotal').text(result[0].Total);
            },
            error: function(ex) {
                console.log(JSON.stringify(ex));
            }
        });
    }

    function getData() {
        var dictlist = {
            Option: "Get Report Data",
            NoSPB: No_Surat
        }
        var dto = {
            Model: dictlist
        }
        $.ajax({
            url: "../UploadMemo/DynamicController?spname=SP_Signature",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var result = JSON.parse(data);
                console.log(result)
                $('#txtGender').text(result[0].GENDER);
                $('#txtName').text(result[0].OWNER);
                $('#txtCompany').text(result[0].SUBDISTBAYAR);
                $('#txtCity').text(result[0].KOTASUBDIST);
                $('#txtPeriode').text(result[0].Periode);
                $('#txtApprover1').text(result[0].Approver1);
                $('#txtApprover2').text(result[0].Approver2);
                $('#txtApprover3').text(result[0].Approver3);
                $('#txtJabatan1').text(result[0].Jabatan1);
                $('#txtJabatan2').text(result[0].Jabatan2);
                $('#txtJabatan3').text(result[0].Jabatan3);
            },
            error: function(ex) {
                console.log(JSON.stringify(ex));
            }
        });
    }

    function approveReport() {
        var dictlist = {
            Option: "Approve Report",
            NoSPB: No_Surat,
            LineNumber: lineNumber,
            Uploader: uploader,
            AlasanReject: 'testing'
        }

        var dto = {
            Model: dictlist
        }
        $.ajax({
            url: "../UploadMemo/DynamicController?spname=SP_Signature",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                Swal.fire({
                    title: "Report Approved!",
                    type: "success",
                    showConfirmButton: false,
                    timer: 3000
                }).then((result) => {
                    window.location.href = '../CMS/CMS_SPBApproval';
                });
                getTableData();
            }, error: function (ex) {
                console.log(JSON.stringify(ex));
            }
        });
    }

    function rejectReport() {
        var dictlist = {
            Option: "Reject Report",
            NoSPB: No_Surat,
            LineNumber: lineNumber,
            AlasanReject: alasanReject,
            Uploader: uploader
        }
        var dto = {
            Model: dictlist
        }
        $.ajax({
            url: "../UploadMemo/DynamicController?spname=SP_Signature",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                Swal.fire({
                    title: "Report Rejected!",
                    type: "success",
                    showConfirmButton: false,
                    timer: 2500
                }).then((result) => {
                    window.location.href = '../CMS/CMS_SPBApproval';
                });
                getTableData();
            }, error: function (ex) {
                console.log(JSON.stringify(ex));
            }
        });
    }

    function getAlasanReject() {
        var dictlist = {
            Option: "Get Alasan Reject",
            NoSPB: No_Surat
        }
        var dto = {
            Model: dictlist
        }
        $.ajax({
            url: "../UploadMemo/DynamicController?spname=SP_Signature",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(dto),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var result = JSON.parse(data);
                $('#txtAlasanReject').text(' ' + result[0].Reject_Reason);
            }, error: function (ex) {
                console.log(JSON.stringify(ex));
            }
        });
    }
</script>
