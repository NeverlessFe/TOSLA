
@{
    ViewBag.Title = "UploadMemoProcess";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style type="text/css">
    #tblItemList_filter {
        display: none;
    }
</style>
<script>
    $(document).ready(function () {
        GetPeriode();
         

      

        $('#tblListMasterSubdist').DataTable({
            "scrollY": "400px",
            "scrollCollapse": true,
            responsive: true, 
            ajax: {
                url: 'GetListMasterSubdist',
                cache: true,
                dataSrc: ""
            },
            columns: [
                {
                    data: null,
                    render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    }
                },
                {
                    data: "KodeSubdist"
                },
                {
                    data: "NamaSubDist"
                }
            ]
        }) 
        $('#modalMasterSubdist').on('shown.bs.modal', function () {
            $($.fn.dataTable.tables(true)).DataTable()
                .columns.adjust();
        });

    });
    $(document).ready(function () {
        //$('#btnShowMasterSubdist').trigger('click');
        $("#btnUploadDataMaster").click(function () {
            $("#divloading").attr("hidden", false);
            var formData = new FormData();
            var PeriodSend = $("#ddlPeriode").val();
            var TypePembayaranSend = $("#ddlTipe").val();
            var totalFiles = document.getElementById("UploadAttachment").files.length;
            for (var i = 0; i < totalFiles; i++) {
                var file = document.getElementById("UploadAttachment").files[i];
                formData.append("UploadAttachment", file);
                //formData.append("NoCAPA", $('#txtNoCAPA').val());
            }
            if (file != null && file != "") {
                $.ajax({
                    type: "POST",
                    url: 'UploadAttachment?Periode=' + PeriodSend + "&TypePembayaran=" + TypePembayaranSend,
                    data: formData,
                    dataType: 'json',
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        $("#divloading").attr("hidden", true);
                        swal("Success", "Upload Memo Berhasil", "success");
                        $("#btnUploadDataMaster").attr("disabled", true);
                        var trHTML = '';
                        var trav = 0;
                        var Count = data.length;

                        console.log(data)
                        if (Count > 0) {
                            let dataInvalid = 0  // count error returned caused by unmatch subdist

                            for (trav = 0; trav < Count; trav++) {
                                // return match status from stored_procedure = data[trav].status
                                if (data[trav].IsValid === 0) {
                                    trHTML += '<tr class="bg-danger text-white"><td>' + data[trav].NoMemo + '</td><td>' + data[trav].Reg + '</td><td>' + data[trav].ShipToID + '</td><td>' + data[trav].Base + '</td><td>' + data[trav].Nama + '</td><td>' + data[trav].Subdist + '</td><td align="right">' + data[trav].KlaimTO + '</td></tr>';
                                    dataInvalid++
                                } else {
                                    trHTML += '<tr><td>' + data[trav].NoMemo + '</td><td>' + data[trav].Reg + '</td><td>' + data[trav].ShipToID + '</td><td>' + data[trav].Base + '</td><td>' + data[trav].Nama + '</td><td>' + data[trav].Subdist + '</td><td align="right">' + data[trav].KlaimTO + '</td></tr>';
                                }
                                $("#tBodyItemList").empty();
                                $("#tblItemList").append(trHTML);
                            }

                            // add error tag
                            if (dataInvalid > 0) {
                                $("#btnSaveDetail").attr("data-error", true);
                            }
                        }
                    },
                    error: function (error) {
                        $("#divloading").attr("hidden", false);
                        $("#btnSaveDetail").attr("data-error", false);
                        alert(error);
                    }
                });
            } else {
                $('#divLoading').attr("hidden", true);
                alert("Pilih Attachment Terlebih dahulu");
            }
        });
    });
    $(document).ready(function () {  

        $("#btnSaveDetail").click(function () {

            if ($(this).attr('data-error') === 'true') {
                swal("Error", "Mohon periksa kembali data anda", "error");
            } else {
                swal({
                    title: "Konfirmasi",
                    text: "Apakah anda yakin ?",
                    type: "info",
                    showCancelButton: !0,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Konfirmasi",
                    closeOnConfirm: !1
                }, function () {
                    KonfirmasiData();
                });
            }
        });
    });
     

    function KonfirmasiData() {
        var NoMemoSend = $("txtNoMemo").val();
        $("#divloading").attr("hidden", false);
        $.ajax({
            type: "POST",
            url: 'KonfirmasiUpload?NoMemoSend=' + NoMemoSend,
            type: "post",
            dataType: "json",
            contentType: false,
            processData: false,
            success: function (data) {
                $("#btnSaveDetail").attr("disabled", true);
                var trHTML = '';
                var trav = 0;
                var Count = data.length;
                if (Count > 0) { 
                    for (trav = 0; trav < Count; trav++) {
                        trHTML += '<tr><td>' + data[trav].NoMemo + '</td><td>' + data[trav].Reg + '</td><td>' + data[trav].ShipToID + '</td><td>' + data[trav].Base + '</td><td>' + data[trav].Nama + '</td><td>' + data[trav].Subdist + '</td><td>' + data[trav].KlaimTO + '</td></tr>';
                        $("#tBodyItemList").empty();
                        $("#tblItemList").append(trHTML);
                    }
                     
                }
                $("#divloading").attr("hidden", true);
                swal("Success", "Konfirmasi Memo berhasil", "success");
            },
            error: function (error) {
                $("#divloading").attr("hidden", true);
                alert(error);
            }
        });
    }

    function GetPeriode() {
        $.ajax({
            url: "GetPeriod",
            type: "post",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                var Count = data.length;
                var trHTML = '';
                var trav = 0;
                if (Count > 0) {
                    for (trav = 0; trav < Count; trav++) {
                        trHTML += '<Option value="' + data[trav] + '">' + data[trav];
                    }
                }

                $("#ddlPeriode").empty();
                $("#ddlPeriode").append(trHTML);
                $('#ddlPeriode').selectpicker();
            }
        });
    }
</script>
<div class="containers">
    <div hidden="hidden">
        <input id="txtNoMemo" type="text" value="@ViewBag.NoMemo" />
    </div>
    <div class="col-md-12">
        <div id="divloading" style="position:fixed;z-index:1000;margin:auto;text-align:center;margin-left:350px;margin-top:200px;" hidden="hidden">
            <img src="~/Content/images/Loading.gif" style="width:50%;height:50%;">
        </div>
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Upload Memo</h4>

                <hr />
                @*<p class="text-muted m-b-15 f-s-12">Use the input classes on an <code>.input-default, input-flat, .input-rounded</code> for Default input.</p>*@
                <div class="basic-form">
                    <div class="row">
                        <div class="col-md-2">
                            Tipe Data
                        </div>
                        <div class="col-md-8">

                            <select id="ddlTipe" class="form-control" title="Tipe">
                                <option>TO</option>
                                <option>SLA</option>
                            </select>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-2">
                            Periode
                        </div>
                        <div class="col-md-8">
                            <select id="ddlPeriode" class="form-control" title="Periode">
                            </select>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-2">
                            Upload Data Master
                        </div>
                        <div class="col-md-8">
                            @using (Html.BeginForm("Index", "Home", FormMethod.Post, new { enctype = "multipart/form-data" }))
                            {
                                <input type="file" name="UploadAttachment" id="UploadAttachment" />

                                <hr />

                                <input type="button" value="Upload" id="btnUploadDataMaster" />
                                <br />
                                <span style="color: green">@ViewBag.Message</span>
                            }
                        </div>
                    </div>
                    @*<button id="btnSaveDetail" type="submit" class="btn btn-dark m-t-20">Save Detail</button>*@
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Item List</h4>

                <hr />
                @*<p class="text-muted m-b-15 f-s-12">Use the input classes on an <code>.input-default, input-flat, .input-rounded</code> for Default input.</p>*@
                <div class="basic-form">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="tblItemList" class="table table-striped table-bordered zero-configuration">
                                <thead>
                                    <tr>
                                        <th>No Memo</th>
                                        <th>Reg</th>
                                        <th>ShipToID</th>
                                        <th>Base</th>
                                        <th>Nama</th>
                                        <th>Subdist</th>
                                        <th>Klaim TO</th>
                                    </tr>
                                </thead>
                                <tbody id="tBodyItemList">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <br />
                    @*-- Add Error Attribute:  220401
                        <button id="btnSaveDetail" type="submit" class="btn btn-dark m-t-20">Konfirmasi File Upload</button>*@
                    <button id="btnSaveDetail" type="submit" data-error="false" class="btn btn-dark m-t-20">Konfirmasi File Upload</button>
                    <button id="btnShowMasterSubdist" type="button" data-toggle="modal" data-target="#modalMasterSubdist" class="btn btn-dark m-t-20">List Master Subdist</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade bd-example-modal-lg" id="modalMasterSubdist" tabindex="-1" role="dialog" aria-labelledby="modalMasterSubdistTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">List Master Subdist</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body px-0 py-0">
                <table id="tblListMasterSubdist" class="table table-striped table-bordered  display " style="width: 100% !important;">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>No Subdist</th>
                            <th>Nama Subdist</th>
                        </tr>
                    </thead>
                    <tbody id="tBodyListMasterSubdist">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
